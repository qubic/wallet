<ng-container *transloco="let t">
  <div class="content_container">
    <h1>{{ t("assetsComponent.title") }}</h1>
    <div class="flex flex-wrap card-list">
      <div *ngIf="assets.length > 0 && !showSendForm ">
        <button mat-raised-button type="button" color="primary" [disabled]="isAssetsLoading" (click)="refreshData()">
          <span *ngIf="!isAssetsLoading">{{ t("assetsComponent.buttons.refresh") }}</span>
          <mat-progress-spinner mode="indeterminate" [diameter]="20" *ngIf="isAssetsLoading">
          </mat-progress-spinner>
        </button>
        <mat-slide-toggle (change)="toggleTableView($event)" [checked]="isTable">{{
          t('seedOverviewComponent.isTable')}}</mat-slide-toggle>
      </div>
      <div class="flex-grow"></div>
      <div style="margin-left: auto; padding-top:14px;" class="text-right">
        <div class="dashboard-amount-container dashboard-amount-name ">
          <qli-balance-hidden></qli-balance-hidden>
        </div>
      </div>
    </div>
    <!-- Only show "no assets" message after smart contracts have loaded to prevent flickering -->
    <div *ngIf="assets.length <= 0 && smartContractsLoaded">
      <mat-card class="asset-card">
        <mat-card-content>
          {{ t("assetsComponent.noAssets") }}
        </mat-card-content>
      </mat-card>
    </div>

    <!-- card version /-->
    <div *ngIf="!isTable">
      <div *ngIf="!showSendForm && smartContractsLoaded" class="card-list flex flex-wrap">
        <mat-card *ngFor="let group of groupedAssets; let i = index">
          <mat-card-content>
            <br>
            <div class="dashboard-wallet-name disable-area">
              {{ getSeedAlias(group.publicId) }}
            </div>
            <br>
            <div class="dashboard-balance-name disable-area">
              {{ group.totalAmount | number:"1.0-0" }} <span class="currency-label">{{ group.assetName }}</span>
            </div>

            <!-- Show contracts breakdown -->
            <ng-container *ngIf="hasContractNames(group.managingContracts)">
              <div class="contract-breakdown">
                <mat-divider></mat-divider>
                <br>
                <div *ngFor="let managingContract of group.managingContracts">
                  <div class="contract-group-header" *ngIf="managingContract.contractName">
                    <span class="dashboard-amount-name">{{ t("assetsComponent.managedBy", { contract: managingContract.contractName }) }}</span>
                  </div>
                  <div class="contract-asset-item" style="padding-left: 10px;">
                    <span class="disable-area">{{ managingContract.asset.ownedAmount | number:"1.0-0" }} {{ managingContract.asset.assetName }}</span>
                  </div>
                </div>
                <br>
              </div>
            </ng-container>

            <div class="text-center">
              <ng-container
                *ngTemplateOutlet="actions; context: { group: group, issuerIdentity: group.issuerIdentity }"></ng-container>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <!-- phone version-->
    <div *ngIf="isTable" class="mobileOnly assetList">
      <span *ngIf="!showSendForm">
        <div *ngIf="groupedAssets.length > 0 && smartContractsLoaded">
          <div class="mobileAssetItem" *ngFor="let group of groupedAssets">
            <h3>
              {{ group.assetName }} <span class="disable-area">- {{ getSeedAlias(group.publicId) }} -
                {{getTotalOwnedAmount(group) | number :"1.0-0"}} ({{ getTotalPossessedAmount(group) | number :"1.0-0"}})</span>
            </h3>

            <div class="copy disable-area" matTooltip="{{ t('general.copy.tooltip') }}"
              [cdkCopyToClipboard]="group.publicId">
              {{ group.publicId }}
            </div>

            <!-- Show managed by info -->
            <ng-container *ngIf="hasContractNames(group.managingContracts)">
              <div style="margin: 10px 0;">
                <div *ngFor="let managingContract of group.managingContracts">
                  <div *ngIf="managingContract.contractName">
                    <span class="dashboard-amount-name">{{ t("assetsComponent.managedBy", { contract: managingContract.contractName }) }}</span>
                  </div>
                  <div style="padding-left: 10px;">
                    <span class="disable-area">{{ managingContract.asset.ownedAmount | number:"1.0-0" }} {{ managingContract.asset.assetName }}</span>
                  </div>
                </div>
              </div>
            </ng-container>

            <div class="flex flex-wrap">
              <ng-container
                *ngTemplateOutlet="actions; context: { group: group, issuerIdentity: group.issuerIdentity }"></ng-container>
            </div>
          </div>
        </div>
      </span>
    </div>

    <!-- table version-->
    <div *ngIf="isTable && !showSendForm && assets.length > 0 && smartContractsLoaded" class="desktopOnly">
      <table mat-table [dataSource]="groupedAssets" class="mat-elevation-z8">
        <!-- Asset Name -->
        <ng-container matColumnDef="publicId">
          <th mat-header-cell *matHeaderCellDef>{{ t("assetsComponent.table.assetName") }}</th>
          <td mat-cell *matCellDef="let group">
            {{ group.assetName }} - {{ getSeedAlias(group.publicId) }}<br>
            <div class="copy disable-area" matTooltip="{{ t('general.copy.tooltip') }}"
              [cdkCopyToClipboard]="group.publicId">
              {{ group.publicId }}
            </div>
          </td>
        </ng-container>

        <!-- Owned Amount -->
        <ng-container matColumnDef="ownedAmount">
          <th mat-header-cell *matHeaderCellDef class="alignRight"> {{ t("assetsComponent.table.ownedAmount") }}
            /<br />{{
            t("assetsComponent.table.possessedAmount") }}</th>
          <td mat-cell *matCellDef="let group" class="alignRight disable-area">
            {{ getTotalOwnedAmount(group) | number :"1.0-0"}} {{ group.assetName }}<br>{{ getTotalPossessedAmount(group) | number :"1.0-0" }} {{ group.assetName }}
          </td>
        </ng-container>

        <!-- Managed By -->
        <ng-container matColumnDef="managedBy">
          <th mat-header-cell *matHeaderCellDef class="alignRight"> {{ t("assetsComponent.table.managedBy") }}</th>
          <td mat-cell *matCellDef="let group" class="alignRight disable-area">
            <div *ngFor="let managingContract of group.managingContracts">
              <ng-container *ngIf="managingContract.contractName">
                {{ managingContract.asset.ownedAmount == undefined || managingContract.asset.ownedAmount == null ? "?" : (managingContract.asset.ownedAmount | number:"1.0-0") }}
                <span class="dashboard-amount-name">{{ t("assetsComponent.by", { contract: managingContract.contractName }) }}</span>
              </ng-container>
            </div>
          </td>
        </ng-container>

        <!-- Tick & Reporting Nodes -->
        <ng-container matColumnDef="tick">
          <th mat-header-cell *matHeaderCellDef class="alignRight"> {{ t("assetsComponent.table.tick") }} / <br /> {{
            t("assetsComponent.table.reportingNodes") }}</th>
          <td mat-cell *matCellDef="let group" class="alignRight">
            <div *ngFor="let managingContract of group.managingContracts">
              {{ managingContract.asset.tick | number: '1.0-0'}}<br />{{ managingContract.asset.reportingNodes?.join(', ') }}
            </div>
          </td>
        </ng-container>

        <!-- Actions -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="alignRight">
            {{ t("seedOverviewComponent.table.actions.title") }}
          </th>
          <td mat-cell *matCellDef="let group" class="alignRight">
            <ng-container
              *ngTemplateOutlet="actions; context: { group: group, issuerIdentity: group.issuerIdentity }"></ng-container>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>

    <ng-template #actions let-group="group" let-issuerIdentity="issuerIdentity">
      <div class="actions-container">
        <button *ngIf="canSendGroupedAsset(group)" mat-icon-button class="icon-color-link" (click)="openSendForm(getQxManagedAsset(group)!)"
          title='{{ t("assetsComponent.buttons.send") }}'>
          <mat-icon>send</mat-icon>
        </button>
        <button *ngIf="canTransferRights(group)" mat-icon-button class="icon-color-link" (click)="openTransferRightsForm(group)"
          title='{{ t("assetsComponent.buttons.transferRights") }}'>
          <mat-icon>swap_horiz</mat-icon>
        </button>
        <button mat-icon-button class="icon-color-link" (click)="openIssuerIdentity(issuerIdentity)"
          title='{{ t("assetsComponent.table.issuerIdentity") }}'>
          <mat-icon>explore</mat-icon>
        </button>
      </div>
    </ng-template>
    <!-- showSendForm -->
    <ng-container *ngIf="showSendForm">
      <mat-card class="sendAssets-card">
        <mat-card-content>
          <h2>{{ t("assetsComponent.form.info") }}</h2>
          <div class="transaction-fee"> {{ t("assetsComponent.form.fees", { fee: assetTransferFee }) }}</div>
          <form [formGroup]="sendForm" (ngSubmit)="onSubmitSendForm()">
            <div class="row">
              <div class="col">
                <mat-form-field appearance="fill" class="full-width">
                  <mat-label>{{ t("assetsComponent.form.select") }}</mat-label>
                  <mat-select formControlName="assetSelect" [compareWith]="compareAssets">
                    <mat-select-trigger>
                      <span *ngIf="getSelectedAsset()">
                        {{ getSeedAlias(getSelectedAsset()?.publicId) }}
                        ({{ shortenAddress(getSelectedAsset()?.publicId) }}) -
                        {{ getSelectedAsset()?.ownedAmount == undefined || getSelectedAsset()?.ownedAmount == null ? "?" : (getSelectedAsset()?.ownedAmount | number: '1.0-0') }}
                        {{ getSelectedAsset()?.assetName }}
                      </span>
                    </mat-select-trigger>
                    <mat-option *ngFor="let asset of getQxAssets()" [value]="asset" class="custom-mat-option">
                      {{ getSeedAlias(asset.publicId) }} ({{ shortenAddress(asset.publicId) }})<br />{{ asset.ownedAmount == undefined
                      || asset.ownedAmount == null ? "?" : asset.ownedAmount | number: '1.0-0'}} {{asset.assetName}}
                    </mat-option>
                  </mat-select>
                  <mat-error *ngIf="sendForm.controls['assetSelect'].hasError('required')">
                    {{ t("assetsComponent.form.select.error") }}
                  </mat-error>
                </mat-form-field>
                <div class="info-note">* {{ t("assetsComponent.form.qxOnly") }}</div>
              </div>
            </div>
            <div class="row">
              <div class="col">
                <mat-form-field appearance="fill" placeholder="Sender Seed" class="full-width"
                  *ngIf="selectedAccountId">
                  <button type="button" matSuffix mat-icon-button (click)="toggleDestinationSelect()"
                    matTooltip="{{ t('paymentComponent.form.receiver.chooseOwnSeed') }}">
                    <mat-icon>account_balance_wallet</mat-icon>
                  </button>
                  <mat-label>{{ t("assetsComponent.form.placeholder") }}</mat-label>
                  <mat-select #selectedDestinationId formControlName="selectedDestinationId">
                    <mat-select-trigger>
                      <span *ngIf="sendForm.controls['selectedDestinationId'].value && getSelectedDestinationSeed()">
                        {{ getSelectedDestinationSeed() | seedDisplay: { compact: true, currencyLabel: t('general.currency') } }}
                      </span>
                    </mat-select-trigger>
                    <mat-option *ngFor="let seed of getSeeds(true); let i = index" [value]="seed.publicId"
                      class="custom-mat-option">
                      {{ seed | seedFirstLine }}<br />{{ seed | seedSecondLine: t('general.currency') }}
                    </mat-option>
                  </mat-select>
                  <mat-error *ngIf="sendForm.controls['selectedDestinationId'].hasError('required')">
                    {{ t("assetsComponent.form.placeholder.error") }}
                  </mat-error>
                </mat-form-field>
                <mat-form-field class="full-width" *ngIf="!selectedAccountId">
                  <mat-label>{{ t("assetsComponent.form.placeholder") }}</mat-label>
                  <input matInput [placeholder]="t('paymentComponent.form.receiver.placeholder')"
                    formControlName="destinationAddress">
                  <button type="button" matSuffix mat-icon-button (click)="toggleDestinationSelect()"
                    matTooltip="{{ t('paymentComponent.form.receiver.chooseOwnSeed') }}">
                    <mat-icon>import_contacts</mat-icon>
                  </button>
                  <mat-error *ngIf="sendForm.controls['destinationAddress'].hasError('required')">
                    {{ t("paymentComponent.form.receiver.error.required") }}
                  </mat-error>
                  <mat-error *ngIf="!sendForm.controls['destinationAddress'].hasError('required') && sendForm.controls['destinationAddress'].hasError('notUppercase')">
                    {{ t("paymentComponent.form.receiver.error.notUppercase") }}
                  </mat-error>
                  <mat-error
                    *ngIf="!sendForm.controls['destinationAddress'].hasError('required') && !sendForm.controls['destinationAddress'].hasError('notUppercase') && (sendForm.controls['destinationAddress'].hasError('minlength') || sendForm.controls['destinationAddress'].hasError('maxlength'))">
                    {{ t("paymentComponent.form.receiver.error.length") }}
                  </mat-error>
                  <mat-error *ngIf="!sendForm.controls['destinationAddress'].hasError('required') && !sendForm.controls['destinationAddress'].hasError('notUppercase') && !sendForm.controls['destinationAddress'].hasError('minlength') && !sendForm.controls['destinationAddress'].hasError('maxlength') && sendForm.controls['destinationAddress'].hasError('invalidAddress')">
                    {{ t("paymentComponent.form.receiver.error.invalidAddress") }}
                  </mat-error>
                </mat-form-field>
              </div>
            </div>
            <div class="row">
              <div class="col">
                <mat-form-field appearance="fill" class="full-width">
                  <mat-label>{{ t("assetsComponent.form.amount") }}</mat-label>
                  <input matInput
                    appAmountInput
                    maxlength="19"
                    formControlName="amount">
                  <mat-error *ngIf="sendForm.controls['amount'].hasError('required')">
                    {{ t("assetsComponent.form.amount.error") }}
                  </mat-error>
                  <mat-error *ngIf="sendForm.controls['amount'].hasError('min')">
                    {{ t("assetsComponent.form.amount.value.error") }}
                  </mat-error>
                  <mat-error *ngIf="sendForm.controls['amount'].hasError('max')">
                    {{ t("assetsComponent.form.amount.max.error") }}
                  </mat-error>
                </mat-form-field>
              </div>
              <div class="col">
                <mat-form-field appearance="fill" class="full-width">
                  <mat-label>{{ t("assetsComponent.form.tick") }}</mat-label>
                  <input matInput type="number" formControlName="tick" [readonly]="!tickOverwrite">
                  <button matSuffix mat-icon-button matTooltip="{{ t('assetsComponent.form.tick.tooltip') }}"
                    (click)="handleTickEdit()" type="button" [class]="{tickOverwrite: tickOverwrite}">
                    <mat-icon>tune</mat-icon>
                  </button>
                  <mat-error *ngIf="sendForm.controls['tick'].hasError('required')">
                    {{ t("assetsComponent.form.tick.error") }}
                  </mat-error>
                  <mat-error *ngIf="sendForm.controls['tick'].hasError('min')">
                    {{ t("assetsComponent.form.tick.min", {currentTick: currentTick}) }}
                  </mat-error>
                </mat-form-field>
              </div>
            </div>

            <div class="transaction-fee"> {{ t("assetsComponent.form.balance", { fee: assetTransferFee }) }} {{ getBalanceAfterFees() | number:
              '1.0-0' }} {{ t("general.currency") }}
            </div>
            <div *ngIf="getBalanceAfterFees() < 0" class="error-message"> {{
              t("assetsComponent.form.buttons.error.balance", { fee: assetTransferFee }) }}
            </div>
            <mat-card-actions class="padding">
              <button mat-raised-button type="button" (click)="cancelSendForm()">
                {{ t("assetsComponent.form.buttons.cancel") }}
              </button>
              <button *ngIf="!walletService.privateKey" mat-raised-button color="primary" type="button"
                (click)="loadKey()">{{ t("paymentComponent.buttons.loadPrivateKey") }}
              </button>
              <button *ngIf="walletService.privateKey" mat-raised-button color="primary" type="submit"
                [disabled]="!sendForm.valid || getBalanceAfterFees() < 0">
                <span *ngIf="!isSending">{{ t("assetsComponent.form.buttons.send") }}</span>
                <mat-progress-spinner *ngIf="isSending" mode="indeterminate" [diameter]="20">
                </mat-progress-spinner>
              </button>
            </mat-card-actions>
          </form>
        </mat-card-content>
      </mat-card>
    </ng-container>

  </div>
</ng-container>